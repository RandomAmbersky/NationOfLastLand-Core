<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Example WASM</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #canvasContainer {
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }
        #output {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>Example WASM Module</h1>

    <div class="container">
        <h2>Core Info</h2>
        <button onclick="showCoreInfo()">Get Core Info</button>
    </div>

    <div class="container">
        <h2>Async Example</h2>
        <button onclick="runAsyncExample()">Run Async</button>
    </div>

    <div class="container">
        <h2>Pixi.js Rendering</h2>
        <button onclick="renderWorld()">Render World with Pixi.js</button>
        <div id="canvasContainer"></div>
    </div>

    <div id="output">
        <strong>Output:</strong><br>
        <div id="result"></div>
    </div>

    <script type="module">
        import init, { get_core_info, async_example, get_world_data } from './pkg/example_wasm.js';

        let pixiApp = null;

        async function run() {
            await init();
            log('WASM module loaded successfully!');
        }

        window.showCoreInfo = function() {
            const info = get_core_info();
            log(`Core Info: ${info}`);
        };

        window.runAsyncExample = async function() {
            try {
                const result = await async_example();
                log(`Async Result: ${result}`);
            } catch (error) {
                log(`Async Error: ${error}`);
            }
        };

        window.renderWorld = async function() {
            console.log('Starting renderWorld');
            const container = document.getElementById('canvasContainer');
            container.innerHTML = ''; // Clear previous canvas

            // Create plain HTML canvas
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            container.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            console.log('Canvas created and added');

            // Fill background white
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 800, 600);

            // Add test text
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('Canvas2D is working!', 10, 30);
            console.log('Test text added');

            // Get world data from WASM
            const worldDataJson = get_world_data();
            console.log('worldDataJson:', worldDataJson);

            let worldData;
            try {
                worldData = JSON.parse(worldDataJson);
                console.log('worldData parsed:', worldData);
            } catch (error) {
                console.error('JSON parse error:', error);
                return;
            }

            log(`Rendered world with ${worldData.wastes.length} wastes and ${worldData.vehicles.length} vehicles`);

            // Scale factor for positions
            const scale = 50;

            // Draw wastes (red squares)
            worldData.wastes.forEach((waste, index) => {
                console.log(`Drawing waste ${index} at pos:`, waste.pos);
                const x = waste.pos.x * scale;
                const y = waste.pos.y * scale;
                ctx.fillStyle = 'red';
                ctx.fillRect(x, y, 20, 20);
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, 20, 20);
                console.log(`Waste drawn at: ${x}, ${y}`);
            });

            // Draw vehicles (blue circles)
            worldData.vehicles.forEach((vehicle, index) => {
                console.log(`Drawing vehicle ${index} at pos:`, vehicle.pos);
                const x = vehicle.pos.x * scale;
                const y = vehicle.pos.y * scale;
                ctx.beginPath();
                ctx.arc(x, y, 15, 0, 2 * Math.PI);
                ctx.fillStyle = 'blue';
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.stroke();
                console.log(`Vehicle drawn at: ${x}, ${y}`);
            });

            console.log('Drawing completed');
        };

        function log(message) {
            const resultDiv = document.getElementById('result');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            console.log(message);
        }

        run();
    </script>
</body>
</html>
